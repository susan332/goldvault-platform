<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gold Asset Vault</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .bg-gold { background-color: #FFD700; }
    .text-gold { color: #FFD700; }
    .border-gold { border-color: #FFD700; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="app" class="min-h-screen">
    <!-- Navigation -->
    <nav class="bg-black text-white p-4 shadow-md">
      <div class="container mx-auto flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <div class="w-10 h-10 bg-gold rounded-full flex items-center justify-center">
            <span class="text-black font-bold">GS</span>
          </div>
          <h1 class="text-xl font-bold">Gold Vault</h1>
        </div>
        <div id="auth-buttons" class="space-x-4">
          <button onclick="showLogin()" class="px-4 py-2 bg-gold text-black rounded hover:bg-yellow-600">Login</button>
          <button onclick="showRegister()" class="px-4 py-2 border border-gold text-gold rounded hover:bg-gray-800">Register</button>
        </div>
        <div id="user-menu" class="hidden">
          <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Logout</button>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto p-4">
      <!-- Login Form -->
      <div id="login-form" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md mt-8 hidden">
        <h2 class="text-2xl font-bold text-center mb-6">Login to Your Account</h2>
        <form id="login" class="space-y-4">
          <div>
            <label class="block text-gray-700">Email</label>
            <input type="email" id="login-email" class="w-full p-2 border rounded" required>
          </div>
          <div>
            <label class="block text-gray-700">Password</label>
            <input type="password" id="login-password" class="w-full p-2 border rounded" required>
          </div>
          <div>
            <label class="block text-gray-700">Role</label>
            <select id="login-role" class="w-full p-2 border rounded">
              <option value="user">User</option>
              <option value="staff">Staff</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <button type="submit" class="w-full bg-gold text-black py-2 rounded hover:bg-yellow-600">Login</button>
        </form>
        <p class="text-center mt-4">
          Don't have an account? <button onclick="showRegister()" class="text-gold hover:underline">Register</button>
        </p>
      </div>

      <!-- Register Form -->
      <div id="register-form" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md mt-8 hidden">
        <h2 class="text-2xl font-bold text-center mb-6">Create Account</h2>
        <form id="register" class="space-y-4">
          <div>
            <label class="block text-gray-700">Name</label>
            <input type="text" id="register-name" class="w-full p-2 border rounded" required>
          </div>
          <div>
            <label class="block text-gray-700">Email</label>
            <input type="email" id="register-email" class="w-full p-2 border rounded" required>
          </div>
          <div>
            <label class="block text-gray-700">Password</label>
            <input type="password" id="register-password" class="w-full p-2 border rounded" required>
          </div>
          <div>
            <label class="block text-gray-700">Role</label>
            <select id="register-role" class="w-full p-2 border rounded">
              <option value="user">User</option>
              <option value="staff">Staff</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <button type="submit" class="w-full bg-gold text-black py-2 rounded hover:bg-yellow-600">Register</button>
        </form>
        <p class="text-center mt-4">
          Already have an account? <button onclick="showLogin()" class="text-gold hover:underline">Login</button>
        </p>
      </div>

      <!-- Dashboard -->
      <div id="dashboard" class="hidden">
        <div id="user-dashboard" class="hidden">
          <h2 class="text-2xl font-bold mb-6">User Dashboard</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
              <h3 class="text-xl font-semibold mb-4">Asset Information</h3>
              <div id="asset-info"></div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
              <h3 class="text-xl font-semibold mb-4">Document Upload</h3>
              <form id="document-upload" enctype="multipart/form-data">
                <div class="mb-4">
                  <label class="block text-gray-700 mb-2">Document Type</label>
                  <select id="doc-type" class="w-full p-2 border rounded" required>
                    <option value="death_cert">Death Certificate</option>
                    <option value="id_proof">ID Proof</option>
                    <option value="payment_proof">Payment Proof</option>
                  </select>
                </div>
                <div class="mb-4">
                  <label class="block text-gray-700 mb-2">Select File</label>
                  <input type="file" id="doc-file" class="w-full p-2 border rounded" required>
                </div>
                <button type="submit" class="bg-gold text-black py-2 px-4 rounded hover:bg-yellow-600">Upload</button>
              </form>
            </div>
          </div>
          <div class="mt-6 bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold mb-4">Withdrawal Request</h3>
            <form id="withdrawal-request">
              <div class="mb-4">
                <label class="block text-gray-700 mb-2">Select Asset</label>
                <select id="request-asset" class="w-full p-2 border rounded" required></select>
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 mb-2">Select Documents</label>
                <div id="document-list" class="space-y-2"></div>
              </div>
              <button type="submit" class="bg-gold text-black py-2 px-4 rounded hover:bg-yellow-600">Submit Request</button>
            </form>
          </div>
        </div>

        <div id="staff-dashboard" class="hidden">
          <h2 class="text-2xl font-bold mb-6">Staff Dashboard</h2>
          <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold mb-4">Pending Requests</h3>
            <div id="staff-requests" class="space-y-4"></div>
          </div>
        </div>

        <div id="admin-dashboard" class="hidden">
          <h2 class="text-2xl font-bold mb-6">Admin Dashboard</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
              <h3 class="text-xl font-semibold mb-4">All Requests</h3>
              <div id="admin-requests" class="space-y-4"></div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
              <h3 class="text-xl font-semibold mb-4">Manage Assets</h3>
              <form id="update-asset">
                <div class="mb-4">
                  <label class="block text-gray-700 mb-2">Current Value ($)</label>
                  <input type="number" id="asset-value" class="w-full p-2 border rounded" required>
                </div>
                <button type="submit" class="bg-gold text-black py-2 px-4 rounded hover:bg-yellow-600">Update</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Global state
      let currentUser = null;
      let token = null;

      // DOM Elements
      const authButtons = document.getElementById('auth-buttons');
      const userMenu = document.getElementById('user-menu');
      const logoutBtn = document.getElementById('logout-btn');
      const loginForm = document.getElementById('login-form');
      const registerForm = document.getElementById('register-form');
      const dashboard = document.getElementById('dashboard');
      const userDashboard = document.getElementById('user-dashboard');
      const staffDashboard = document.getElementById('staff-dashboard');
      const adminDashboard = document.getElementById('admin-dashboard');

      // Show/Hide functions
      function showLogin() {
        loginForm.classList.remove('hidden');
        registerForm.classList.add('hidden');
      }

      function showRegister() {
        registerForm.classList.remove('hidden');
        loginForm.classList.add('hidden');
      }

      function showDashboard() {
        loginForm.classList.add('hidden');
        registerForm.classList.add('hidden');
        dashboard.classList.remove('hidden');
        authButtons.classList.add('hidden');
        userMenu.classList.remove('hidden');
        
        if (currentUser.role === 'user') {
          userDashboard.classList.remove('hidden');
          staffDashboard.classList.add('hidden');
          adminDashboard.classList.add('hidden');
          loadUserData();
        } else if (currentUser.role === 'staff') {
          userDashboard.classList.add('hidden');
          staffDashboard.classList.remove('hidden');
          adminDashboard.classList.add('hidden');
          loadStaffData();
        } else if (currentUser.role === 'admin') {
          userDashboard.classList.add('hidden');
          staffDashboard.classList.add('hidden');
          adminDashboard.classList.remove('hidden');
          loadAdminData();
        }
      }

      // Event Listeners
      document.getElementById('login').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const role = document.getElementById('login-role').value;
        
        try {
          const response = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, role })
          });
          
          const data = await response.json();
          if (response.ok) {
            currentUser = data.user;
            token = data.token;
            localStorage.setItem('goldVaultToken', token);
            showDashboard();
          } else {
            alert(data.message || 'Login failed');
          }
        } catch (err) {
          console.error(err);
          alert('Login error');
        }
      });

      document.getElementById('register').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('register-name').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const role = document.getElementById('register-role').value;
        
        try {
          const response = await fetch('/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, password, role })
          });
          
          const data = await response.json();
          if (response.ok) {
            alert('Registration successful! Please login.');
            showLogin();
          } else {
            alert(data.message || 'Registration failed');
          }
        } catch (err) {
          console.error(err);
          alert('Registration error');
        }
      });

      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('goldVaultToken');
        currentUser = null;
        token = null;
        dashboard.classList.add('hidden');
        authButtons.classList.remove('hidden');
        userMenu.classList.add('hidden');
      });

      // Load data functions
      async function loadUserData() {
        try {
          const [assetsRes, docsRes] = await Promise.all([
            fetch('/api/assets', {
              headers: { 'Authorization': `Bearer ${token}` }
            }),
            fetch('/api/documents', {
              headers: { 'Authorization': `Bearer ${token}` }
            })
          ]);
          
          const assets = await assetsRes.json();
          const documents = await docsRes.json();
          
          // Display asset info
          document.getElementById('asset-info').innerHTML = `
            <div class="mb-4">
              <h4 class="font-semibold">${assets[0].name}</h4>
              <div class="grid grid-cols-2 gap-4 mt-2">
                <div>
                  <p class="text-sm text-gray-600">Original Value</p>
                  <p class="font-semibold">$${assets[0].originalValue.toLocaleString()}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-600">Current Value</p>
                  <p class="font-semibold text-green-600">
                    $${assets[0].currentValue.toLocaleString()}
                  </p>
                </div>
                <div>
                  <p class="text-sm text-gray-600">Status</p>
                  <p class="capitalize">${assets[0].status}</p>
                </div>
              </div>
            </div>
          `;
          
          // Populate asset select for request
          document.getElementById('request-asset').innerHTML = assets
            .map(asset => `<option value="${asset._id}">${asset.name} (${asset.status})</option>`)
            .join('');
            
          // Display documents for selection
          document.getElementById('document-list').innerHTML = documents
            .map(doc => `
              <div class="flex items-center">
                <input type="checkbox" id="doc-${doc._id}" value="${doc._id}" class="mr-2">
                <label for="doc-${doc._id}">${doc.type} - ${new Date(doc.uploadedAt).toLocaleDateString()}</label>
              </div>
            `)
            .join('');
        } catch (err) {
          console.error(err);
        }
      }

      // Check for existing token on page load
      window.addEventListener('load', () => {
        const savedToken = localStorage.getItem('goldVaultToken');
        if (savedToken) {
          // Verify token and load user data
          try {
            const decoded = jwt_decode(savedToken);
            currentUser = { id: decoded.id, role: decoded.role };
            token = savedToken;
            showDashboard();
          } catch (err) {
            localStorage.removeItem('goldVaultToken');
          }
        }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
  </div>
</body>
</html>
